{% extends 'auth/base_auth.html' %}

{% block title %}Confirm Email{% endblock %}

{% block auth_subtitle %}Processing your email confirmation...{% endblock %}

{% block auth_content %}
<div class="confirmation-container text-center">
    <div id="loading-state">
        <div class="spinner-border text-success mb-4" role="status" style="width: 60px; height: 60px;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 class="text-muted">Verifying your email...</h4>
        <p class="text-muted small">Please wait while we confirm your email address.</p>
    </div>
    
    <div id="success-state" style="display: none;">
        <div class="mb-4">
            <i class="fas fa-check-circle" style="font-size: 80px; color: #2c5530;"></i>
        </div>
        <h3 class="fw-bold mb-3" style="color: #2c5530;">Email Confirmed!</h3>
        <p class="text-muted mb-4">
            Your email address has been successfully verified. Redirecting to complete registration...
        </p>
    </div>
    
    <div id="error-state" style="display: none;">
        <div class="mb-4">
            <i class="fas fa-times-circle" style="font-size: 80px; color: #dc3545;"></i>
        </div>
        <h3 class="fw-bold mb-3" style="color: #dc3545;">Verification Failed</h3>
        <p class="text-muted mb-4" id="error-message">
            The confirmation link is invalid or has expired.
        </p>
        <a href="{% url 'register_step1_email' %}" class="btn-auth d-inline-block" style="text-decoration: none;">
            <i class="fas fa-redo me-2"></i>Start Over
        </a>
    </div>
</div>

<style>
    .confirmation-container {
        padding: 40px 0;
        min-height: 300px;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get hash parameters from URL (Supabase sends tokens in hash)
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    
    // Get tokens from hash (Supabase format)
    const accessToken = params.get('access_token');
    const refreshToken = params.get('refresh_token');
    const type = params.get('type');
    const error = params.get('error');
    const errorDescription = params.get('error_description');
    
    console.log('[AUTH_CONFIRM] Hash params:', { accessToken: !!accessToken, type, error });
    
    // Check for errors first
    if (error) {
        showError(errorDescription || error);
        return;
    }
    
    // If we have an access token, verify it and redirect to step 3
    if (accessToken) {
        console.log('[AUTH_CONFIRM] Verifying access token...');
        verifyToken(accessToken, refreshToken);
    } else {
        showError('No verification token found in email link.');
    }
    
    function verifyToken(token, refresh) {
        // Send to backend to verify and set up session, then redirect to step 3
        fetch('{% url "auth_confirm_verify" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                access_token: token,
                refresh_token: refresh
            })
        })
        .then(response => {
            console.log('[AUTH_CONFIRM] Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('[AUTH_CONFIRM] Verification result:', data);
            if (data.success) {
                showSuccess();
                // Redirect immediately to step 3
                setTimeout(() => {
                    console.log('[AUTH_CONFIRM] Redirecting to step 3...');
                    window.location.href = '{% url "register_step3_details" %}';
                }, 500);
            } else {
                showError(data.error || 'Email verification failed. Please try again.');
            }
        })
        .catch(err => {
            console.error('[AUTH_CONFIRM] Error:', err);
            showError('Network error. Please check your connection and try again.');
        });
    }
    
    function showSuccess() {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('success-state').style.display = 'block';
        document.getElementById('error-state').style.display = 'none';
    }
    
    function showError(message) {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('success-state').style.display = 'none';
        document.getElementById('error-state').style.display = 'block';
        document.getElementById('error-message').textContent = message;
        console.error('[AUTH_CONFIRM] Error shown:', message);
    }
});
</script>
{% endblock %}
